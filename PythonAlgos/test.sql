with dates as (     select '2021-04-25'::date as business_date ), stats as (     select         avg(metric_sum) as avg       , case when stddev(metric_sum) = 0 then 0.000001 else stddev(metric_sum) end as sd     from     (       select a.business_date as business_date, sum(metric_value) as metric_sum       from fact_disney_behavior_glimpsev2_sessions_metric_store a, dates       where metric_id = '290'       and (a.business_date between dateadd('day', -30, dates.business_date) and dates.business_date)       and a.dw_load_ts_est = (                             select max(dw_load_ts_est)                             from fact_disney_behavior_glimpsev2_sessions_metric_store b                             where a.business_date = b.business_date                             and metric_id = '290'                           )       group by 1     ) ), counts as (     select sum(metric_value) as metric_sum     from fact_disney_behavior_glimpsev2_sessions_metric_store a, dates     where metric_id = '290'     and a.business_date = dates.business_date     and dw_load_ts_est = (                           select max(dw_load_ts_est)                           from fact_disney_behavior_glimpsev2_sessions_metric_store b                           where a.business_date = b.business_date                           and metric_id = '290'                        ) ), thresholds as (     select         nvl(z_score_check_warning_threshold, 3.0) as warning_threshold       , nvl(z_score_check_error_threshold, 5.0) as error_threshold     from disney_plus.metric_thresholds     where threshold_id = (                             select threshold_id                             from disney_plus.metric_d                             where metric_id = '290'                          ) ) select      'z_score check' as dq_check    , case         when abs(counts.metric_sum - stats.avg)/sd >= warning_threshold then 2         when abs(counts.metric_sum - stats.avg)/sd >= error_threshold then 1         else 0     end as result from stats, counts, thresholds